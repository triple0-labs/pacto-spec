name: NPM Publish

on:
  release:
    types:
      - published
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.release.tag_name, 'v')
    steps:
      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout tagged ref
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Upgrade npm for trusted publishing compatibility
        run: npm install -g npm@^11.5.1

      - name: Validate package version matches tag
        shell: bash
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          EXPECTED="${TAG#v}"
          ACTUAL="$(node -p "require('./package.json').version")"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "package.json version ($ACTUAL) does not match tag ($EXPECTED)"
            exit 1
          fi

      - name: Validate release assets (release trigger only)
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const assets = context.payload.release.assets.map(a => a.name);
            if (!assets.includes("checksums.txt")) {
              core.setFailed("Release is missing checksums.txt");
              return;
            }
            if (!assets.some((n) => n.startsWith("pacto_") && n.endsWith(".tar.gz"))) {
              core.setFailed("Release is missing pacto_<version>_<os>_<arch>.tar.gz artifacts");
            }

      - name: Publish package
        run: npm publish --access public --provenance
